//#include<stdio.h> 
//#include<string.h>
//#include<iostream>
#include "DB_new.cpp"
#include <regex>

using namespace std;

#include <fstream>
#include <iostream>
#include <limits>
#include <string>
#include <string.h>
#include <regex>
#include <stdio.h>
using namespace std;

template <typename T>
static T get_input(const std::string& strQuery);
static std::string get_username();
static std::string get_password();
static std::string get_mail();
static void login_as_client();
static void login_after_chose_login_as_client();
static void login_as_agent();
static void register_user();
static bool Check_if_user_name_exists(string user_name);
static void main_menu();
static void client_menu(string username);
static bool Email_check(string email);
static void home_page();
static void Order_management();
static void messages();
static void add_package_to_db();
static string get_destination();
static float get_price();
static int get_number_of_passengers();
static void print_all_packages();
static void edit_package();
static void agent_menu();
///// STATMENT OF ADD NEW PACKAGE FUNCTION
static void package_management();
static void Reply_to_messages_by_an_agent();


static Date get_start_date_of_package();
static Date get_end_date_of_package();




///// STATMENT OF ALL UPDATE FUNCTION
static void edit_by_price();
static void edit_by_arrive_date();
static void edit_by_leave_date();
static int get_serial_number();
static void edit_by_arrive_date();


///// STATMENT OF ALL OREDER MENGMENT FUNCTION
static void Approve_cancel_order();
static void Approve_order();
static void Cancel_order();
static void login_as_agent();




int size_after_filter = PackegesfileSize();

static void Print_vacations(Packege  vacations)
{
	printPackege(vacations);
}

static void Print_all_vacations(Packege* vacations, int size)
{
	for (int i = 0; i < size; i++)
	{
		printPackege(vacations[i]);
	}
}



//  Find customer from DB by user name
static Client Find_customer(string user_name)
{
	Client* customer = getAllClients();
	int size = ClientsfileSize();
	Client temp;
	for (int i = 0; i < size; i++)
	{
		if (customer[i].user_name == user_name)
			return customer[i];
	}
	std::cout << "The user name not found The process failed, please try again  " << endl;
	string username;
	std::cout << "enter user name:" << endl;
	std::cin >> username;
	client_menu(username);
}

//  Find customer from DB by user name and return pointer to him(בשביל הפונקציה של ההודעות)
static Client* Find_customer2(string user_name)
{
	Client* customer = getAllClients();
	int size = ClientsfileSize();
	Client temp;
	for (int i = 0; i < size; i++)
	{
		if (customer[i].user_name == user_name)
			return &customer[i];
	}
	std::cout << "The user name not found " << endl;
	return NULL;
}

static int Length_of_card(int y)
{
	int count = 0;
	while (y)
	{
		count++;
		y /= 10;

	}
	return count;
}

static bool check_date(Date date1, Date date2)
{
	if (date1.day == date2.day && date1.month == date2.month && date1.year == date2.year)
		return true;
	return false;
}

static void PrintWishList(Client customer)
{
	bool check = false;
	int choise, serial_number;
	Packege* vacations = getAllPackeges();
	int size = PackegesfileSize();
	for (int i = 0; i < 20; i++)
	{
		if (customer.wish_list[i] != 0)
		{
			for (int j = 0; j < size; j++)
			{
				if (vacations[j].serial_number == customer.wish_list[i])
					Print_vacations(vacations[j]);
			}
		}
	}
}


// copy constructor for date
static void Copy_date(Date* sourse, Date* target)
{
	target->day = sourse->day;
	target->month = sourse->month;
	target->year = sourse->year;
}

// copy constructor for date
static void copy_message(Message* sourse, Message* target)
{
	for(int i =0; i<50;i++)
		target->title[i] = sourse->title[i];
	for (int i = 0; i < 300; i++)
		target->content[i] = sourse->content[i];
	for (int i = 0; i < 10; i++)
		target->status[i] = sourse->status[i];
	Copy_date(&(sourse->sending_date), &(target->sending_date));
	for (int i = 0; i < 300; i++)
		target->response[i] = sourse->response[i];
}


// copy constructor for vacation

static void Copy_vacations(Packege* sourse, Packege* target)
{
	target->number_of_passengers = sourse->number_of_passengers;
	Copy_date(&(sourse->start), &(target->start));
	Copy_date(&(sourse->end), &(target->end));
	for (int i = 0; i < 100; i++)
		target->destination[i] = sourse->destination[i];
	target->price = sourse->price;
	target->serial_number = sourse->serial_number;
	for (int i = 0; i < 20; i++)
		target->status[i] = sourse->status[i];
}

// sort by date
static Packege* Sort_by_date(Packege* vacations, int size)
{
	Packege* sort_by_date = new Packege[size];
	for (int i = 0; i < size; i++)
	{
		//sort_by_date[i] = new Vacation[1];
		Copy_vacations(&(vacations[i]), &(sort_by_date[i]));
	}
	int i, j;
	Packege temp;
	for (i = 1; i < size; i++)
	{
		Copy_vacations(&(sort_by_date[i]), &(temp));
		j = i - 1;
		while (j >= 0 && ((sort_by_date[j].start.year > temp.start.year) || ((sort_by_date[j].start.year == temp.start.year) && (sort_by_date[j].start.month > temp.start.month)) || ((sort_by_date[j].start.year == temp.start.year) && (sort_by_date[j].start.month == temp.start.month) && sort_by_date[j].start.day > temp.start.day)))
		{
			Copy_vacations(&(sort_by_date[j]), &(sort_by_date[j + 1]));
			j = j - 1;
		}
		Copy_vacations(&(temp), &(sort_by_date[j + 1]));
	}
	return sort_by_date;
}

//Sort by price
static Packege* Sort_by_price(Packege* vacations, int size)
{
	Packege* sort_by_price = new Packege[size];
	for (int i = 0; i < size; i++)
	{
		//sort_by_price[i] = new Vacation[1];
		Copy_vacations(&(vacations[i]), &(sort_by_price[i]));
	}
	int i, j;
	Packege temp;
	for (i = 1; i < size; i++)
	{
		Copy_vacations(&(sort_by_price[i]), &(temp));
		j = i - 1;
		while (j >= 0 && sort_by_price[j].price > temp.price)
		{
			Copy_vacations(&(sort_by_price[j]), &(sort_by_price[j + 1]));
			j = j - 1;
		}
		Copy_vacations(&(temp), &(sort_by_price[j + 1]));
	}
	return sort_by_price;
}

static bool Payment(int x)
{
	Packege* vacation = getAllPackeges();
	int index_where_the_pacakge_is = searchPackegeBySerialNumber(x);
	int price, id, card, cvc, Expire_date;
	string full_name;
	bool choise = true;
	if (index_where_the_pacakge_is == -1)
		std::cout << "Error , package is'nt exist" << endl;
	else
	{
		price = vacation[index_where_the_pacakge_is].price;
		std::cout << "The price to pay is:" << price << endl;
		std::cout << "Please enter your full name" << endl;
		std::cin >> full_name;
		std::cout << "Please enter your ID" << endl;
		std::cin >> id;
		while (choise)
		{
			std::cout << "Please enter the debit card number" << endl;
			std::cin >> card;
			std::cout << "Enter the expiration date of a card enter- 4 number 2 for month then 2 for year" << endl;
			std::cin >> Expire_date;
			std::cout << "Insert the last 3 digits on the back of the card" << endl;
			std::cin >> cvc;
			if (Length_of_card(card) == 9) {
				std::cout << "The card is charged" << endl;
				return true;
			}
			else
			{
				std::cout << "Invalid card" << endl;
				std::cout << "if u want to try again Press 1-for yes or 0-for no:";
				std::cin >> choise;
			}
			if (choise == 0)
				return false;
		}
	}
}

static void Order_status(string user_name)
{
	Client customer = Find_customer(user_name);// לבדוק מה קורה אם חוזר 0 זה בעיה
	int choise = 0;
	int size = PackegesfileSize();
	Packege* vacations = getAllPackeges();
	int size_vacation = customer.vacations_list_size;
	for (int i = 0; i < size_vacation; i++)
	{
		for (int j = 0; j < size_vacation; j++)
		{
			if (vacations[j].serial_number == customer.vacations_list[i])
			{
				if (vacations[j].status == "in_process")
					std::cout << "Pending approuv " << endl;
				Print_vacations(vacations[j]);
				std::cout << "If you want to cancel the order press 1 " << endl;
				std::cin >> choise;
				if (choise == 1)
				{
					UpdatePackegeStatus(3, vacations[j].serial_number);
					std::cout << "Order Number: " << customer.vacations_list[i] << " Canceled " << endl;
				}
			}

		}

	}
	return;
}

static void Order_vacation(int Serial_number)
{
	string user, name1, last;
	bool check2 = false;
	int choise, phone, temp, x = 1;
	bool check, check3;
	Packege* vacations = getAllPackeges();
	int size = PackegesfileSize();
	for (int i = 0; i < size; i++)
	{
		if (vacations[i].serial_number == Serial_number)
		{

			check2 = true;
			std::cout << "To order now press 1/n To Back Press 2 " << endl;
			std::cin >> choise;
			while (choise > 2 || choise < 1)
			{
				std::cout << "Wrong choice Please try again" << endl;
				std::cin >> choise;
			}
			if (choise == 1)
			{
				std::cout << "Enter a username" << endl;
				std::cin >> user;
				std::cout << "Enter a name" << endl;
				std::cin >> name1;
				std::cout << "Enter a last name" << endl;
				std::cin >> last;
				std::cout << "Enter a phone number" << endl;
				const char* user_name = user.c_str();
				const char* name = name1.c_str();
				const char* last_name = last.c_str();
				std::cin >> phone;
				//בדיקת תקינות מס טלפון
				while (x != 10)
				{
					x = 1;
					temp = phone;
					while (temp != 0)
					{
						temp = temp / 10;
						x++;
					}
					if (x != 10)
					{
						std::cout << "Incorrect phone number try again " << endl;
						std::cin >> phone;
					}
				}
				check3 = UpdateClientsOrderDetails(user_name, name, last_name, phone);
				if (!check3)
				{
					std::cout << "The system was unable to update the package information" << endl;
					client_menu(user_name);
				}
				else
				{
					check = Payment(Serial_number);
					if (check)
					{
						std::string username(user_name);
						UpdatePackegeStatus(2, Serial_number);
						Order_status(username);
						client_menu(user_name);

					}
					else
					{
						UpdatePackegeStatus(3, Serial_number);
						std::cout << "Payment canceled " << endl;
						client_menu(user_name);
					}
				}
			}
			if (choise == 2)
				client_menu(user);
		}
	}
	if (!check2)
	{
		std::cout << "Serial number not exist " << endl;
		client_menu(user);
	}
}

//return size of vacations by location
static int Get_size_vacations_by_location(Packege* vacations, string location)
{

	int counter = 0;
	for (int i = 0; i < size_after_filter; i++)
	{
		if (vacations[i].destination == location)
			counter++;
	}
	size_after_filter = counter;
	return size_after_filter;
}

//filter by destenation
static Packege* Get_vactions_by_location(Packege* vacation, string location)
{
	int size1 = size_after_filter;
	Packege temp;
	Packege* vacations = vacation;
	int counter = Get_size_vacations_by_location(vacations, location);
	int size = counter;
	Packege* new_vacations = new Packege[counter];
	counter = 0;
	for (int i = 0; i < size1; i++)
	{
		if (vacations[i].destination == location)
		{
			//new_vacations[i] = new Vacation[1];
			Copy_vacations(&(vacations[i]), &(new_vacations[counter]));
			counter++;
		}
	}

	return new_vacations;
}


//return size of vacations by passenger amount
static int Get_size_vacations_by_amount(Packege* vacations, int amount)
{
	int counter = 0;
	for (int i = 0; i < size_after_filter; i++)
	{
		if (vacations[i].number_of_passengers == amount)
			counter++;
	}
	size_after_filter = counter;
	return size_after_filter;
}

//filter by  passenger amount
static Packege* Get_vactions_by_passenger_amount(Packege* vacation, int amount)
{
	int size1 = size_after_filter;
	Packege temp;
	Packege* vacations = vacation;
	int counter = Get_size_vacations_by_amount(vacations, amount);
	int size = counter;
	Packege* new_vacations = new Packege[counter];
	counter = 0;
	for (int i = 0; i < size1; i++)
	{
		if (vacations[i].number_of_passengers == amount)
		{
			//new_vacations = new Vacation[1];
			Copy_vacations(&(vacations[i]), &(new_vacations[counter]));
			counter++;
		}
	}

	return new_vacations;
}


//return size of vacations by date
static int Get_size_vacations_by_date(Packege* vacations, Date check_in, Date check_out)
{
	int counter = 0;
	for (int i = 0; i < size_after_filter; i++)
	{
		if (vacations[i].start.day == check_in.day && vacations[i].start.month == check_in.month && vacations[i].start.year == check_in.year)
		{
			if (vacations[i].end.day == check_out.day && vacations[i].end.month == check_out.month && vacations[i].end.year == check_out.year)
				counter++;
		}
	}
	size_after_filter = counter;
	return size_after_filter;
}

//filter by date
static Packege* Get_vactions_by_date(Packege* vacation, Date check_in, Date check_out)
{
	int size1 = size_after_filter;
	Packege temp;
	Packege* vacations = vacation;
	int counter = Get_size_vacations_by_date(vacations, check_in, check_out);
	int size = counter;
	Packege* new_vacations = new Packege[counter];
	counter = 0;
	for (int i = 0; i < size1; i++)
	{
		if (check_date(vacation[i].start, check_in) && check_date(vacation[i].end, check_out))
		{
			//new_vacations = new Vacation[1];
			Copy_vacations(&(vacation[i]), &(new_vacations[counter]));
			counter++;
		}
	}
	return new_vacations;
}

static void Package_filtering()
{
	bool check4 = false;
	Client customer;
	int Serial_number_selected;
	int choise;
	Date check_in, check_out;
	string destination, user_name;
	int  passenger_amount, check, back, check2;
	int size = PackegesfileSize();
	Packege* vacations = getAllPackeges();
	std::cout << "If you want to back to menu  select 1 or select 0 to continue" << endl;
	std::cin >> check;
	if (check == 1)
		agent_menu();
	std::cout << "Please enter a destination or select 0 to continue" << endl;
	std::cin >> destination;
	std::cout << "Please enter a passenger amount or select 0 to continue" << endl;
	std::cin >> passenger_amount;
	std::cout << "If you want to enter check-in and check-out select 1 or select 0 to continue" << endl;
	std::cin >> check2;
	if (destination != "0")
		vacations = Get_vactions_by_location(vacations, destination);
	if (passenger_amount != 0)
		vacations = Get_vactions_by_passenger_amount(vacations, passenger_amount);
	if (check2 == 1)
	{
		std::cout << "enter check in : day: \n month:\n year: \n" << endl;
		std::cin >> check_in.day >> check_in.month >> check_in.year;
		std::cout << "enter check out :\n day: \n month:\n year: \n" << endl;
		std::cin >> check_out.day >> check_out.month >> check_out.year;
		vacations = Get_vactions_by_date(vacations, check_in, check_out);
	}
	std::cout << "If you want to sort by date, select 1" << endl;
	std::cout << "If you want to sort by price, select 2" << endl;
	std::cout << "If you want to sort by price and by date, select 3" << endl;
	std::cout << "If you  dont want to sort , select 0" << endl;
	std::cout << "If you want to just add to wish list, select 4" << endl;
	std::cin >> check;
	while (check > 4 || check < 0)
	{
		std::cout << "Wrong choice Please try again" << endl;
		std::cin >> check;
	}
	if (vacations == NULL)
	{
		std::cout << "No suitable package was found" << endl;
		Package_filtering();
	}
	if (check == 1)
		Print_all_vacations(Sort_by_date(vacations, size_after_filter), size_after_filter);
	if (check == 2)
		Print_all_vacations(Sort_by_price(vacations, size_after_filter), size_after_filter);
	if (check == 3)
		Print_all_vacations(Sort_by_date(Sort_by_price(vacations, size_after_filter), size_after_filter), size_after_filter);
	if (check == 0)
		Print_all_vacations(vacations, size_after_filter);
	std::cout << "Enter the package number you selected" << endl;
	std::cin >> Serial_number_selected;
	check2 = searchPackegeBySerialNumber(Serial_number_selected);
	while (check2 == -1)
	{
		std::cout << "Wrong choice Please try again" << endl;
		std::cin >> Serial_number_selected;
		check2 = searchPackegeBySerialNumber(Serial_number_selected);
	}
	if (check == 4)
	{
		std::cout << "enter user name" << endl;
		std::cin >> user_name;
		const char* user_name_new = user_name.c_str();
		customer = Find_customer(user_name);// לבדוק מה קורה אם חוזר 0 זה בעיה
		check4 = UpdateClientWishlist(user_name_new, Serial_number_selected);
		if (check4)
			std::cout << "The package has been added to the wish list" << endl;
		else
			std::cout << "The package was not added to the wish list" << endl;
		client_menu(user_name);
	}
	else
	{
		UpdatePackegeStatus(1, Serial_number_selected);
		Order_vacation(Serial_number_selected);
	}
}

static void Find_vacation()
{
	bool check4 = false;
	Client customer;
	string user_name;
	int choise, Serial_number_selected, check, check2 = -1;
	std::cout << "Please select an option:" << endl;
	std::cout << "To view existing packages, select - 1" << endl;
	std::cout << "To filter packages, select - 2" << endl;
	std::cout << "for back select - 3" << endl;
	std::cin >> choise;
	while (choise > 3 || choise < 1)
	{
		std::cout << "Wrong choice Please try again" << endl;
		std::cin >> choise;
	}
	if (choise == 1)
	{

		std::cout << "If you dont want to sort , select 0" << endl;
		std::cout << "If you want to sort by date, select 1" << endl;
		std::cout << "If you want to sort by price, select 2" << endl;
		std::cout << "If you want to sort by price and by date, select 3" << endl;
		std::cout << "If you want to just add to wish list, select 4" << endl;
		std::cin >> check;
		while (check > 4 || check < 0)
		{
			std::cout << "Wrong choice Please try again" << endl;
			std::cin >> check;
		}
		if (check == 0)
			Print_all_vacations(getAllPackeges(), PackegesfileSize());
		if (check == 1)
			Print_all_vacations(Sort_by_date(getAllPackeges(), PackegesfileSize()), PackegesfileSize());
		if (check == 2)
			Print_all_vacations(Sort_by_price(getAllPackeges(), PackegesfileSize()), PackegesfileSize());
		if (check == 3)
			Print_all_vacations(Sort_by_date(Sort_by_price(getAllPackeges(), PackegesfileSize()), PackegesfileSize()), PackegesfileSize());
		if (check == 4)
		{
			Print_all_vacations(getAllPackeges(), PackegesfileSize());
			std::cout << "Enter the package number you selected to put in wish list" << endl;
			std::cin >> Serial_number_selected;
			check2 = searchPackegeBySerialNumber(Serial_number_selected);
			while (check2 == -1)
			{
				std::cout << "Wrong choice Please try again" << endl;
				std::cin >> Serial_number_selected;
				check2 = searchPackegeBySerialNumber(Serial_number_selected);
			}
			std::cout << "enter user name" << endl;
			std::cin >> user_name;
			customer = Find_customer(user_name);// לבדוק מה קורה אם חוזר 0 זה בעיה
			const char* user_name_new = user_name.c_str();
			check4 = UpdateClientWishlist(user_name_new, Serial_number_selected);
			if(check4)
				std::cout << "The package has been added to the wish list" << endl;
			else
				std::cout << "The package was not added to the wish list" << endl;
			client_menu(user_name);
		}
		std::cout << "Enter the package number you selected" << endl;
		std::cin >> Serial_number_selected;//בדיקה שנבחר מס סידורי קיים
		check2 = searchPackegeBySerialNumber(Serial_number_selected);
		while (check2 == -1)
		{
			std::cout << "Wrong choice Please try again" << endl;
			std::cin >> Serial_number_selected;
			check2 = searchPackegeBySerialNumber(Serial_number_selected);
		}
		UpdatePackegeStatus(1, Serial_number_selected);
		Order_vacation(Serial_number_selected);
	}
	if (choise == 2)
		Package_filtering();
	if (choise == 3)
		return;// חזרה למסך הראשי של סוכן\לקוח
}


// Wish list
static void Wish_list(string user_name)
{
	bool check = false;
	int choise, serial_number;
	Client temp = Find_customer(user_name);// לבדוק מה קורה אם חוזר 0 זה בעיה
	cout << "The packages that you liked: " << endl;
	PrintWishList(temp);
	cout << "If you want to place an order Select 1, To return to the main menu, press 0" << endl;
	cin >> choise;
	while (choise < 0 || choise > 1)
	{
		cout << "Wrong choice Please try again" << endl;
		cin >> choise;
	}
	if (choise == 1)
	{
		cout << "enter seria number" << endl;
		cin >> serial_number;
		while (!check)
		{
			for (int i = 0; i < 20; i++)
			{
				if (temp.wish_list[i] == serial_number)
					check = true;
			}
			if (check)
				Order_vacation(serial_number);
			else
				cout << "the serial number not found in wish list" << endl;
		}
	}
	if (choise == 0)
		return;
}



static void Masseges(string user_name)
{
	Message message;
	int choise;
	cout << "To contact us, press 1, to continue press 0 " << endl;
	cin >> choise;
	while (choise < 0 || choise > 1)
	{
		cout << "Wrong choice Please try again" << endl;
		cin >> choise;
	}
	if (choise == 1)
	{
		cout << "enter title: " << endl;
		cin >> message.title;
		cout << "enter content: " << endl;
		cin >> message.content;
		cout << "enter date:\n day: \n month:\n year: \n" << endl;
		cin >> message.sending_date.day >> message.sending_date.month >> message.sending_date.year;
		

	   const char* user_name_new = user_name.c_str();
		UpdateClientMessage(user_name_new, message);
		
	}
	cout << "My Masseges" << endl;
	int i = 0;
	bool check = false;
	Client* customer = Find_customer2(user_name);
	while (!check)
	{
		if (customer->message_list[i].content[0] != '0')
		{
			printMassege(customer->message_list[i]);
			i++;
		}
		else
			check = true;
	}
}



static void package_management()
{
	int choice;
	do
	{
		print_all_packages();
		cout <<
			"[1] add new package" "\n"
			"[2] edit package" "\n"
			"[3] back to agent menu" "\n";
		cout << "Enter ur choise:";
		cin >> choice;
		switch (choice)
		{
		case 1:
			add_package_to_db();
			break;
		case 2:
			edit_package();
			break;
		case 3:
			agent_menu();
			break;
		}
	} while (true);
}

static void add_package_to_db()
{
	Packege New;
	Date start_of_package, end_of_package;

	string destination;
	float price;
	int day, month, year, number_of_passengers;
	start_of_package = get_start_date_of_package();
	end_of_package = get_end_date_of_package();
	destination = get_destination();
	const char* p_destination = destination.c_str();
	price = get_price();
	number_of_passengers = get_number_of_passengers();
	New = creatNewPackege(p_destination, price, start_of_package, end_of_package, number_of_passengers);
	if (setPackegeToDB(New))
	{
		cout << "package added successfully" "\n";
	}
	else
		cout << "Failed to add package, contact your administrator " "\n";
	print_all_packages();
}

static Date get_start_date_of_package()
{
	Date start;
	int day, month, year;
	cout << "Enter start date of package:" << endl;
	cout << "day:" << endl;
	cin >> day;
	cout << "month:" << endl;
	cin >> month;
	cout << "year:" << endl;
	cin >> year;
	start = getNewDate(day, month, year);
	return start;

}

static Date get_end_date_of_package()
{
	Date end;
	int day, month, year;
	cout << "Enter end date of package:";
	cout << "day:" << endl;
	cin >> day;
	cout << "month:" << endl;
	cin >> month;
	cout << "year:" << endl;
	cin >> year;
	end = getNewDate(day, month, year);
	return end;
}

//
static string get_destination()
{
	bool check_if_re_enter;
	string destination;
	cout << "Enter destination :"<<endl;
	cin >> destination;
	while (destination.size() >= 100)
	{
		cout << "destination name must be up to 100 characters, press 0 to exit and move to agent menu or 1 to re-enter destination name: ";
		cin >> check_if_re_enter;
		if (check_if_re_enter)
		{
			cout << "enter destination name: ";
			cin >> destination;

		}
		else
			agent_menu();

	}
	return destination;
}

static float get_price()
{
	int check_if_price_below_equal_0;
	float price;
	cout << "Enter price :";
	cin >> price;
	while (price <= 0)
	{
		cout << "price can't be below\equal to 0, press 0 to exit and move to agent menu or 1 to re-enter price : ";
		cin >> check_if_price_below_equal_0;
		if (check_if_price_below_equal_0)
		{
			cout << "enter new price: ";
			cin >> price;

		}
		else
			agent_menu();

	}
	return price;
}

static int get_number_of_passengers()
{
	bool check_if_passengers_below_equal_0;
	int get_number_of_passengers;
	cout << "how many people are you :";
	cin >> get_number_of_passengers;
	while (get_number_of_passengers <= 0)
	{
		cout << "number of passengers can't be below\equal to 0, press 0 to exit and move to agent menu or 1 to re-enter price : ";
		cin >> check_if_passengers_below_equal_0;
		;
		if (check_if_passengers_below_equal_0)
		{
			cout << "how many people are you :";
			cin >> get_number_of_passengers;

		}
		else
			agent_menu();

	}
	return get_number_of_passengers;
}

static void print_all_packages()
{
	int size_of_db_all_package;
	Packege* all_packages;
	all_packages = getAllPackeges();
	size_of_db_all_package = PackegesfileSize();
	for (int i = 0; i < size_of_db_all_package; ++i)
	{
		printPackege(all_packages[i]);
	}
}

static void Reply_to_messages_by_an_agent()
{
	bool check = false;
	string respone;
	string user_name;
	int choise, index;

	if (PrintAllUnReadMasseges() == 1)
	{
		std::cout << "To respond select 1, return to the menu Select 0" << endl;
		std::cin >> choise;
		while (choise > 1 || choise < 0)
		{
			std::cout << "Wrong choice Please try again" << endl;
			std::cin >> choise;
		}
		while (choise == 1)
		{
			std::cout << "enter user name of Client that you respone him:" << endl;
			std::cin >> user_name;
			std::cout << "enter index of Client that you respone him:" << endl;
			std::cin >> index;
			std::cout << "enter your respone:" << endl;
			std::cin >> respone;
			const char* user_name_new = user_name.c_str();
			const char* respone_new = respone.c_str();
			while (strlen(respone_new) > 299)
			{
				std::cout << "the respone should be up tp 300 characters, enter again: " << endl;
				std::cin >> respone;
			}
			check = UpdateClientMessageResponse(user_name_new, respone_new, index);
			if (check)
				std::cout << "The response was sent " << endl;
			else
				std::cout << "No response wasn't sent. Please try again " << endl;
		}
		agent_menu();
	}
	else if (PrintAllUnReadMasseges()==-1) 
	{
		cout << "failed to open file" << endl;

	}
	else 
	{
		cout << "There is no messages" << endl;

	}
}



//############################################################package_management :  EDIT PACKAGE TO DB ##########################################

static void edit_package()
{
	int choice;
	do
	{
		cout <<
			"[1] edit by price" "\n"
			"[2] edit by arrive date" "\n"
			"[3] edit by leave date" "\n"
			"[4] back to agent menu" "\n";
		cout << "Enter ur choise:";
		cin >> choice;
		switch (choice)
		{
		case 1:
			edit_by_price();
			break;
		case 2:
			edit_by_arrive_date();
			break;
		case 3:
			edit_by_leave_date();
			break;
		case 4:
			agent_menu();
			break;
		}
	} while (true);
}

static void edit_by_price()
{
	print_all_packages();

	int serial_number;
	float new_price;
	serial_number = get_serial_number();
	new_price = get_price();
	if (UpdatePackegePrice(new_price, serial_number))
		cout << "price has updated succesfiyl""\n";
	else
		cout << "price has updated failed""\n";
	edit_package();
}

static int get_serial_number()
{
	int serial_number;
	cout << "enter serial number of package that u want to edit:";
	cin >> serial_number;
	if (searchPackegeBySerialNumber(serial_number) != -1 && searchPackegeBySerialNumber(serial_number) != -2)
	{
		return serial_number;
	}
	return -1;
}

static void edit_by_arrive_date()
{
	print_all_packages();
	Date arrival_date;
	int serial_number;
	serial_number = get_serial_number();
	arrival_date = get_start_date_of_package();
	if (UpdatePackegeArrivalDate(arrival_date, serial_number))
		cout << "arrive date has updated succesfiyl""\n";
	else
		cout << "arrive date has updated failed""\n";

	edit_package();

}

static void edit_by_leave_date()
{
	print_all_packages();
	Date leave_date;
	int serial_number;
	serial_number = get_serial_number();
	leave_date = get_end_date_of_package();
	if (UpdatePackegeLeavingDate(leave_date, serial_number))
		cout << "leave date has updated succesfiyl""\n";
	else
		cout << "leave date has updated failed""\n";

	edit_package();
}

//############################################################Order_management  ##########################################


static void Order_management()
{

	int choice;
	do
	{
		cout <<
			"[1] Approve/cancel order" "\n"
			"[2] back to agent menu" "\n";

		cout << "Enter ur choise:";
		cin >> choice;
		switch (choice)
		{
		case 1:
			Approve_cancel_order();
			break;
		case 2:
			agent_menu();
			break;
		}
	} while (true);
}

static void Approve_cancel_order()
{
	int choice;
	do
	{
		cout <<
			"[1] Approve order" "\n"
			"[2] Cancel order" "\n";

		cout << "Enter ur choise:";
		cin >> choice;
		switch (choice)
		{
		case 1:
			Approve_order();
			break;
		case 2:
			Cancel_order();
			break;
		}
	} while (true);

}

static void Approve_order()
{
	int serial_number;
	if (PrintAllPackagesAwaitingApproval() == 1 )
	{
		cout << "enter serial number of package that u want to approve:";
		cin >> serial_number;
		if (UpdatePackegeStatus(4, serial_number))
			cout << "Updated to approve successfully""\n";
		else
			cout << "Updated to approve failed ""\n";
	}
	else
	{
		cout << "there is no packages that waits for you""\n";

	}

	Order_management();
}

static void Cancel_order()
{
	int serial_number;
	if (PrintAllPackagesAwaitingApproval() == 1)
	{
		cout << "enter serial number of package that u want to cancel:";
		cin >> serial_number;
		if (UpdatePackegeStatus(3, serial_number))
			cout << "Updated to approve successfully""\n";
		else
			cout << "Updated to approve failed ""\n";
	}
	else
	{
		cout << "there is no packages that waits for you""\n";

	}

	Order_management();
}



























/////////// HOME PAGE OF PROGRAM /////////////
static void home_page() {

	std::cout << "#############################################################" << endl;
	std::cout << "#                 Welcome to Harel Tours                    #" << endl;
	std::cout << "#                    _                                      #" << endl;
	std::cout << "#                  -=\\`\\                                    #" << endl;
	std::cout << "#              |\\ ____\\_\\___                                #" << endl;
	std::cout << "#            -=\\c`_________ _`)                             #" << endl;
	std::cout << "#               `~~~~~/ /~~`\                                #" << endl;
	std::cout << "#                 -==/ /                                    #" << endl;
	std::cout << "#                   '-'                                     #" << endl;
	std::cout << "#                  _  _                                     #" << endl;
	std::cout << "#                 ( `   )_                                  #" << endl;
	std::cout << "#                (    )    `)                               #" << endl;
	std::cout << "#              (_   (_ .  _) _)                             #" << endl;
	std::cout << "#                                             _             #" << endl;
	std::cout << "#                                            (  )           #" << endl;
	std::cout << "#                                          ( `  ) . )       #" << endl;
	std::cout << "#           Hotel                         (_, _(  ,_)_)     #" << endl;
	std::cout << "#         |_______|                                         #" << endl;
	std::cout << "#         |_______|                                         #" << endl;
	std::cout << "#         |_______|                                         #" << endl;
	std::cout << "#         |_______|                                         #" << endl;
	std::cout << "#         |_______|                                         #" << endl;
	std::cout << "#         |_______|                                         #" << endl;
	std::cout << "#         |_______|                                         #" << endl;
	std::cout << "#         |_______|                                         #" << endl;
	std::cout << "#############################################################" << endl;
	main_menu();
}
/////////// MAIN_MENU OF PROGRAM /////////////
static void main_menu()
{
	int choice;
	do
	{
		std::cout << "Hello, Would you like to login(register inside login) in or register?" "\n"
			"[1] Login as client" "\n"
			"[2] Login as agent" "\n"
			"[3] Exit""\n";
		std::cout << "Enter your choise:";
		std::cin >> choice;
		while (choice > 3 || choice < 1)
		{
			std::cout << "wrong choise try again:"<<endl;
			std::cin >> choice;
		}
		switch (choice)
		{
		case 1:
			login_as_client();
			break;
		case 2:
			login_as_agent();
			break;
		case 3:
			exit(1);
			break;
		}
	} while (true);
}
/////////// CHOOSE LOGIN AS CLIENT ( 4 OPTIONS :1-LOGIN 2-REGISTER 3-GO BACK TO MAIN MENU /////////////
static void login_as_client()
{
	int choise;
	do
	{
		std::cout << "For login press 1 ""\n"
			"For register press 2""\n"
			"return to home page 3""\n"
			"Enter ur choise:";
		std::cin >> choise;
		switch (choise)
		{
		case 1:
			login_after_chose_login_as_client();
			break;
		case 2:
			register_user();
			break;
		case 3:
			main_menu();
			break;
		}
	} while (true);
}
/////////// LOGIN AS CLIENT /////////////
static void login_after_chose_login_as_client()
{
	Client* Customer_Information = getAllClients();
	string username = get_username();
	string password = get_password();
	const char* username1 = username.c_str();
	const char* password1 = password.c_str();
	int size_of_users = ClientsfileSize();
	bool keep_trying = true;

	for (int i = 0; i < size_of_users; ++i)
	{

		if (strcmp(Customer_Information[i].user_name, username1) == 0)
		{
			while (keep_trying)
			{
				if (strcmp(Customer_Information[i].password, password1) == 0)
				{
					client_menu(username);
				}
				else
				{
					std::cout << "Incorrect password do you want to re-enter the password? 0-No , 1-Yes " << endl;
					std::cin >> keep_trying;
					if (keep_trying)
					{
						password = get_password();
						password1 = password.c_str();
					}
				}
			}
		}
	}
	std::cout << "User hasn't found""\n";
	main_menu();
}
/////////// SHOW CLIENT MENU : 1-FIND_VACTION 2-ORDER STATUS 3-WISH_LIST 4-MESSAGES 5 HOME PAGE 6 EXIT/////////////
static void client_menu(string username) {
	int choice;
	do
	{
		std::cout <<
			"[1] Find a vaction" "\n"
			"[2] Order status" "\n"
			"[3] Wish list" "\n"
			"[4] Messages""\n"
			"[5] Home page(You will have to reconnect)""\n"
			"[6] Exit" "\n";

		std::cout << "Enter ur choise:";
		std::cin >> choice;
		switch (choice)
		{
		case 1:
			Find_vacation();
			break;
		case 2:
			Order_status(username);
			break;
		case 3:
			Wish_list(username);
			break;
		case 4:
			Masseges(username);
			break;
		case 5:
			home_page();
			break;
		case 6:
			exit(0);
			break;
		}
	} while (true);
};
/////////// REGISTER NEW CLIENT IF SUCCSESS SEND TO LOGIN ELSE PRINT FAILED AND RETURN TO HOME PAGE /////////////
static void register_user()
{
	std::string username;
	bool keep_trying = true;
	while (keep_trying)
	{
		username = get_username();
		if (Check_if_user_name_exists(username)) //// if user name existed, return false
		{
			keep_trying = false;
		}
		else
		{
			std::cout << "name is already used , want to try another name?0-No ,1-Yes:";
			std::cin >> keep_trying;
			if (keep_trying == 0)
			{
				home_page();
			}
		}
	}

	std::string password = get_password();
	std::string mail = get_mail();

	const char* username1 = username.c_str();
	const char* password1 = password.c_str();
	const char* mail1 = mail.c_str();

	Client new_acc = creatNewClient(username1, password1, mail1);   ///////////// createNewClient return clint
	if (setClientToDB(new_acc))
	{
		std::cout << "create has succeed""\n";
		login_after_chose_login_as_client();
	}
	else
	{
		std::cout << "create hasn't succeed , try again later""\n";
		home_page();
	}
}
/////////// IF USER EXIST RETURN FALSE ELSE RETURN TRUE /////////////
static bool Check_if_user_name_exists(string user_name)
{
	Client* db_all_clients = getAllClients();
	int size_of_all_clients = ClientsfileSize();
	const char* username1 = user_name.c_str();
	bool keep_trying = true;
	for (int i = 0; i < size_of_all_clients; ++i)
	{
		if (strcmp(db_all_clients[i].user_name, username1) == 0)
		{
			return false;
		}
	}
	return true;
}


template <typename T>
static T get_input(const std::string& strQuery)
{
	std::cout << strQuery << "\n> ";
	T out = T();

	while (!(std::cin >> out)) {
		std::cin.clear();
		std::cin.ignore(std::numeric_limits <std::streamsize>::max(), '\n');
		std::cout << "Error!" "\n";
		std::cout << strQuery << "\n> ";
	}

	return out;
}

/////////// RETURN PASSWORD ,CONDITION UP TO 8 CHARACTERS /////////////
static std::string get_password()
{

	std::string password1 = get_input <std::string>("Please enter your password.");
	while (password1.size() >= 8)
	{
		std::cout << "Error! Password up to 8 characters." "\n";
		password1 = get_input <std::string>("Please enter your password.");
	}
	std::string password2 = get_input <std::string>("Please re-enter your password.");

	while (password1 != password2) {
		std::cout << "Error! Passwords do not match." "\n";
		password1 = get_input <std::string>("Please enter your password.");
		password2 = get_input <std::string>("Please re-enter your password.");
	}

	return password1;
}
/////////// RETURN NAME UP TO 100 CHARACTERS /////////////
static std::string get_username()
{
	std::string username = get_input <std::string>("Please enter a username.");
	while (username.size() >= 100)
	{
		std::cout << "Error! username should be up to 100 characters." "\n";
		username = get_input <std::string>("Please enter a username.");
	}
	return username;
}
/////////// RETURN MAIL ONLY IF HE VALID  /////////////
static std::string get_mail()
{
	string mail;
	std::cout << "Enter your Email-Id:";
	std::cin >> mail;
	bool flag = true;
	while (flag)
	{
		while (mail.size() >= 20 && (!(Email_check(mail))))
		{
			std::cout << "Error! mail should be up to 20 characters." "\n";
			mail = get_input <std::string>("Please enter a username.");
		}

		while (!(Email_check(mail)))
		{
			std::cout << "bad email , try again:";
			std::cin >> mail;
		}
		if (mail.size() <= 20 && Email_check(mail))
			return mail;
	}
	return "";
}
/////////// CHECK IF MAIL IS VALID , IF ITS OK RETURN TRUE ELSE FALSE   /////////////
static bool Email_check(string email)
{
	const regex pattern("(\\w+)(\\.|_)?(\\w*)@(\\w+)(\\.(\\w+))+");
	return regex_match(email, pattern);
}







///////////login_as_agent /////////////
static void login_as_agent()
{
	int check_what_returns_from_CheckingValidityAgentDetials;
	string username = get_username();
	string password = get_password();
	const char* username1 = username.c_str();
	const char* password1 = password.c_str();

	check_what_returns_from_CheckingValidityAgentDetials = CheckingValidityAgentDetials(username1, password1);
	if (check_what_returns_from_CheckingValidityAgentDetials == -2)
		cout << "You are not registered in the system, contact with ur work manager ""\n";
	if (check_what_returns_from_CheckingValidityAgentDetials == -1)
		cout << " password is incorrect ""\n";
	if (check_what_returns_from_CheckingValidityAgentDetials == 0)
		agent_menu();
	if (check_what_returns_from_CheckingValidityAgentDetials == -3)
		cout << "file opening failed ""\n";

	home_page();

}



///////////NOT FINISH /////////////



static void agent_menu() {
	int choice;

	do
	{
		std::cout <<
			"[1] package management" "\n"
			"[2] Order management" "\n"
			"[3] Messages" "\n"
			"[4] Home page(You will have to reconnect)""\n"
			"[5] Exit" "\n";
		std::cout << "Enter ur choise:";
		std::cin >> choice;
		switch (choice)
		{
		case 1:
			package_management();
			break;
		case 2:
			Order_management();
			break;
		case 3:
			Reply_to_messages_by_an_agent();
			break;
		case 4:
			home_page();
			break;
		case 5:
			exit(0);
			break;
		}
	} while (true);
};



int main()
{
	home_page();
	return 0;
}
